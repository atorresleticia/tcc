\chapter{TPC Benchmark H}
\label{tpch}

O TPC \textit{Benchmark} H (TPC-H) é um \textit{Benchmark} de suporte à decisão de negócios constituído de uma série de consultas comerciais \textit{ad-hoc} e modificações simultâneas de dados com finalidade de retratar a realidade das empresas. Ele representa sistemas de suporte à decisão que examinam grandes volumes de dados; executam consultas com um alto grau de complexidade; e respondem questões críticas de negócio. Como o \textit{Benchmark} trata de grandes volumes de dados, o tamanho mínimo de banco de dados proposto pelo TPC-H é de 1GB, seguido por 10GB, 30GB, 100GB, 300GB, 1000GB, 3000GB, 10000GB, 30000GB e 100000GB. Aqui serão tratados as classes de 1GB, 10GB e 30GB.

São fornecidos também os dados para popular o DW através do software DBGen; bem como o conjunto de consultas e funções que devem ser executadas sobre esses dados. Com esse software é possível definir o tamanho do banco de dados, ou seja, a classe dele.

Precisa de mais bla bla bla sobre o TPC-H e o DBGen e QBgen.

\section{Ambiente de Análise 1}
O primeiro ambiente de análise é um esquema normalizado proposto pelo próprio TPC-H, denominado \textit{Snow Flake}. Ele é composto por oito tabelas. Destas, seis têm o tamanho multiplicado por um Fator de Escala (SF\footnote{SF: Scale Factor}), que corresponde ao tamanho da classe do banco de dados; enquanto que as demais têm tamanho fixo. O relacionamento entre as tabelas do esquema \textit{Snow Flake} é apresentado na Figura ?. As Tabelas \ref{1gb_table}, \ref{10gb_table} e \ref{30gb_table} mostram detalhes de Cardinalidade e Tamanho das tabelas para cada classe de banco de dados. A coluna Cardinalidade se refere ao número de tuplas da tabela, que é calculado multiplicando o respectivo SF (1, 10 ou 30) pelo número mínimo de tuplas, oriundo da classe de 1GB. As exceções são as tabelas REGION e NATION, que tem valor fixo para tal.

\begin{table}[htpb]
\centering
\caption{Dados para a classe de 1GB}
\label{1gb_table}
\begin{tabular}{|l|c|c|}
\hline
\multicolumn{1}{|c|}{\textbf{Nome da tabela}} & \textbf{Cardinalidade} & \textbf{Tamanho} \\ \hline
CUSTOMER                                      & 150 K                  & 23.3 MB          \\ \hline
LINEITEM                                      & 6 M                    & 730 MB           \\ \hline
NATION                                        & 25                     & 2.19 KB          \\ \hline
ORDERS                                        & 1.5 M                  & 165 MB           \\ \hline
PART                                          & 200 K                  & 23.2 MB          \\ \hline
PARTSUPP                                      & 800 K                  & 114 MB           \\ \hline
REGION                                        & 5                      & 394 Bytes        \\ \hline
SUPPLIER                                      & 10 K                   & 1.35 MB          \\ \hline
Total																					&	?											 & ?								\\ \hline
\end{tabular}
\end{table}

\begin{table}[htpb]
\centering
\caption{Dados para a classe de 10GB}
\label{10gb_table}
\begin{tabular}{|l|c|c|}
\hline
\multicolumn{1}{|c|}{\textbf{Nome da tabela}} & \textbf{Cardinalidade} & \textbf{Tamanho} \\ \hline
CUSTOMER                                      & 1.5 M                  & 234 MB          	\\ \hline
LINEITEM                                      & 60 M                   & 7.29 GB          \\ \hline
NATION                                        & 25                     & 2.19 KB          \\ \hline
ORDERS                                        & 15 M                   & 1.64 GB          \\ \hline
PART                                          & 2 M                  	 & 233 MB          	\\ \hline
PARTSUPP                                      & 8 M                  	 & 1.12 GB          \\ \hline
REGION                                        & 5                      & 394 Bytes        \\ \hline
SUPPLIER                                      & 100 K                  & 13.6 MB          \\ \hline
Total																					&	?											 & ?								\\ \hline
\end{tabular}
\end{table}

\begin{table}[htpb]
\centering
\caption{Dados para a classe de 30GB}
\label{30gb_table}
\begin{tabular}{|l|c|c|}
\hline
\multicolumn{1}{|c|}{\textbf{Nome da tabela}} & \textbf{Cardinalidade} & \textbf{Tamanho} \\ \hline
CUSTOMER                                      & 4.5 m                  & 706 MB           \\ \hline
LINEITEM                                      & 180 M                  & 22.1 GB          \\ \hline
NATION                                        & 25                     & 2.19 KB          \\ \hline
ORDERS                                        & 450 M                  & 4.97 GB          \\ \hline
PART                                          & 6 M                  	 & 704 MB           \\ \hline
PARTSUPP                                      & 24 M                   & 3.41 GB          \\ \hline
REGION                                        & 5                      & 394 Bytes        \\ \hline
SUPPLIER                                      & 30 K                   & 41 MB            \\ \hline
Total																					&	?											 & ?								\\ \hline
\end{tabular}
\end{table}

Detalhes sobre o tipo de dados de cada tabela e as consultas SQL relacionadas a esse ambiente são encontradas nos Apêndices \ref{dados_sf} e ?.


\section{Ambiente de Análise 2}

-> Falar sobre vantagens de um ambiente desnormalizado

-> Definir o esquema do ambiente

-> Definir as queries

-> Definir o tamanho das tuplas

-> Pesquisar como é gerado um novo ambiente no DBGen


\section{Metodologia}

Cada SGBD é executado sobre os dois ambientes propostos. Em cada ambiente será executado o teste de performance, que consiste de duas rodadas: o teste de força (\textit{Power Test}) e o teste de vazão (\textit{Throughput Test}), descritos nas Subseções \ref{power_test} e \ref{through_test}, respectivamente. O tempo resultante de cada etapa é utilizado para calcular o desempenho final do SGBD, medido em \textit{QphH@Size} – quantidade de consultas executadas por hora, dada uma classe de tamanho de banco de dados. Uma rodada é composta por alguns componentes:

\begin{itemize}
	\item \textit{$Q_{i}$} representa uma consulta, onde \textit{1 \leq i \leq 22}.
	\item \textit{S} define o número de sessões de consulta do Teste de Vazão.
	\item \textit{s} representa uma dada sessão, onde \textit{1 \leq s \leq S}.
	\item \textit{RF_j} representa a Função de atualização.
		\subitem RF1: inserção de novos registros. O número de registros inseridos deve ser igual para o número de registros removidos pela RF2.
		\subitem RF2: remoção de registros antigos.
	\item \textit{SF} representa a classe do banco de dados.
\end{itemize}

\subsection{Teste de Força}
\label{power_test}
O Teste de Força objetiva medir a execução de uma dada consulta do sistema com um único usuário ativo. Neste teste é criada uma única sessão com o respectivo SGBD e as seguintes instruções são executadas:

\begin{itemize}
	\item Execução da RF1.
	\item Execução de cada consulta proposta pelo TPC-H, ou adaptada, de forma sequencial uma única vez até a última consulta.
	\item Execução da RF2.
\end{itemize}

Será armazenado ao fim do teste o tempo em segundos resultante de cada consulta, bem como o tempo de execução de cada função. Este resultado será utilizado na Equação


\subsection{Teste de Vazão}
\label{through_test}
Este teste mede a capacidade do sistema de processar a maior quantidade possível de consultas no menor intervalo de tempo. Aqui o TPC-H exige um número mínimo de sessões de consulta de acordo com a classe de tamanho do banco de dados, como mostra a Tabela \ref{min_sessions}. 

\begin{table}[htpb]
\centering
\caption{Número mínimo de sessões para uma dada classe}
\label{min_sessions}
\begin{tabular}{|l|c|c|}
\hline
\multicolumn{1}{|c|}{\textbf{Classe do Banco de Dados}} & \textbf{Número de Sessões} \\ \hline
1 GB                                      & 2                            \\ \hline
10 GB                                      & 3                          \\ \hline
30 GB                                        & 4                             \\ \hline
\end{tabular}
\end{table}

É criada uma sessão para executar as Funções e \textit{N} sessões para executar as consultas, de acordo com a Tabela \ref{min_sessions}. As instruções são executadas concorrentemente. Para a sessão das Funções, as seguintes instruções são executadas:

\begin{itemize}
	\item A RF1 e RF2 deverão ser executadas sequencialmente \textit{N} vezes, onde \textit{N} é o número de sessões para a execução de consultas.
	\item Para cada sessão de consultas, cada consulta será executada sequencialmente até a última.
\end{itemize}

Ao fim do teste, é armazenado o tempo em segundos da execução do processo inteiro. O processo inicia quando a primeira sessão, seja de consulta ou de Função, executa sua instrução e finazalia quando a última sessão recebe uma resposta. O resultado é utilizado para calcular o desempenho do SGBD para o Teste de Vazão conforme a Equação ?.

O resultado dos cálculos de Força e Vazão serão utilizados para calcular o desempenho final do SGBD da seguinte forma:

